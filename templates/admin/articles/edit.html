{% extends "admin/base.html" %}

{% block title %}Edit Article - FastAPI CMS{% endblock %}

{% block header_title %}Edit Article{% endblock %}

{% block additional_css %}
<!-- Ensure Toast UI Editor CSS is loaded -->
<link
  rel="stylesheet"
  href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
/>
<style>
  /* Card header dark mode styles */
  [data-theme="dark"] .card-header {
    background-color: var(--card-bg);
    border-bottom-color: var(--border-color);
  }
  
  [data-theme="dark"] .card-header h5,
  [data-theme="dark"] .card-header h6 {
    color: var(--text-color);
  }
  
  [data-theme="dark"] .card-header.bg-light {
    background-color: var(--card-bg) !important;
    border-bottom-color: var(--border-color);
  }
  
  /* Form label and text styles for dark mode */
  [data-theme="dark"] .form-label,
  [data-theme="dark"] .form-check-label {
    color: var(--text-color);
  }
  
  [data-theme="dark"] .form-text,
  [data-theme="dark"] .text-muted {
    color: var(--text-muted, #cccccc) !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Edit Article: {{ article.title }}</h5>
                </div>
                <div class="card-body">
                    {% if error %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        {{ error }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endif %}

                    <form method="POST" action="/admin/articles/{{ article.id }}/edit" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ article.title }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="slug" class="form-label">Slug</label>
                            <input type="text" class="form-control" id="slug" name="slug" value="{{ article.slug or '' }}">
                            <div class="form-text">Leave empty to auto-generate from title. The slug is used in URLs and should be URL-friendly.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="excerpt" class="form-label">Excerpt</label>
                            <textarea class="form-control" id="excerpt" name="excerpt" rows="3">{{ article.excerpt or '' }}</textarea>
                            <div class="form-text">A short summary of the article that appears on listing pages. Leave empty to use the beginning of the content.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category_id" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="category_id" name="category_id" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if category.id == article.category_id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="featured_image" class="form-label">Featured Image</label>
                            <div class="card p-3">
                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="image_source" id="image_url_option" value="url" {% if article.featured_image %}checked{% endif %}>
                                        <label class="form-check-label" for="image_url_option">Use URL</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="image_source" id="image_upload_option" value="upload" {% if not article.featured_image %}checked{% endif %}>
                                        <label class="form-check-label" for="image_upload_option">Upload File</label>
                                    </div>
                                </div>
                                
                                <div id="url_input_section" class="mb-2 {% if not article.featured_image %}d-none{% endif %}">
                                    <input type="url" class="form-control" id="featured_image_url" name="featured_image_url" 
                                           value="{{ article.featured_image or '' }}" placeholder="https://example.com/image.jpg">
                                </div>
                                
                                <div id="file_upload_section" class="mb-2 {% if article.featured_image %}d-none{% endif %}">
                                    <input type="file" class="form-control" id="featured_image_file" name="featured_image_file" accept="image/*">
                                </div>
                                
                                {% if article.featured_image %}
                                <div class="mt-2">
                                    <p class="mb-1">Current image:</p>
                                    <img src="{{ article.featured_image }}" alt="Featured image" class="img-thumbnail" style="max-height: 150px">
                                </div>
                                {% endif %}
                                
                                <div class="form-text mt-2">
                                    Choose an option above. You can either provide a URL to an online image or upload a local file.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="content" class="form-label">Content <span class="text-danger">*</span></label>
                            <div id="editor"></div>
                            <input type="hidden" name="content" id="content-input" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tags" class="form-label">Tags</label>
                            <select class="form-select" id="tags" name="tag_ids" multiple>
                                {% for tag in tags %}
                                <option value="{{ tag.id }}" {% if tag in article.tags %}selected{% endif %}>
                                    {{ tag.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Hold Ctrl (Cmd on Mac) to select multiple tags</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="footer_content" class="form-label">Footer Content</label>
                            <div id="footer-editor"></div>
                            <input type="hidden" name="footer_content" id="footer-content-input">
                            <div class="form-text">Additional content to display at the end of the article (disclaimers, source attributions, etc.)</div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="published" name="published" {% if article.published %}checked{% endif %}>
                            <label class="form-check-label" for="published">Published</label>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="/admin/articles" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Update Article</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block additional_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get initial content from the article
        const initialContent = `{{ article.content|safe }}`;
        const initialFooterContent = `{{ article.footer_content|safe }}`;
        
        // Initialize Toast UI Editor with existing content
        const editor = new toastui.Editor({
            el: document.querySelector('#editor'),
            height: '500px',
            initialEditType: 'wysiwyg',
            initialValue: initialContent,
            previewStyle: 'vertical',
            toolbarItems: [
                ['heading', 'bold', 'italic', 'strike'],
                ['hr', 'quote'],
                ['ul', 'ol', 'task', 'indent', 'outdent'],
                ['table', 'image', 'link'],
                ['code', 'codeblock']
            ],
            hooks: {
                addImageBlobHook: async (blob, callback) => {
                    const formData = new FormData();
                    formData.append('file', blob);
                    
                    try {
                        const response = await fetch('/api/upload/image/web', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Image upload failed');
                        }
                        
                        const data = await response.json();
                        callback(data.url);
                    } catch (error) {
                        console.error('Error uploading image:', error);
                        alert('Failed to upload image. Please try again.');
                    }
                }
            }
        });
        
        // Initialize Toast UI Editor for footer content
        const footerEditor = new toastui.Editor({
            el: document.querySelector('#footer-editor'),
            height: '300px',
            initialEditType: 'wysiwyg',
            initialValue: initialFooterContent,
            previewStyle: 'vertical',
            toolbarItems: [
                ['heading', 'bold', 'italic', 'strike'],
                ['hr', 'quote'],
                ['ul', 'ol', 'task', 'indent', 'outdent'],
                ['table', 'image', 'link'],
                ['code', 'codeblock']
            ],
            hooks: {
                addImageBlobHook: async (blob, callback) => {
                    const formData = new FormData();
                    formData.append('file', blob);
                    
                    try {
                        const response = await fetch('/api/upload/image/web', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Image upload failed');
                        }
                        
                        const data = await response.json();
                        callback(data.url);
                    } catch (error) {
                        console.error('Error uploading image:', error);
                        alert('Failed to upload image. Please try again.');
                    }
                }
            }
        });
        
        // Handle form submission to capture editor content
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get HTML content from editors and set it to the hidden inputs
            const htmlContent = editor.getHTML();
            document.getElementById('content-input').value = htmlContent;
            
            const footerHtmlContent = footerEditor.getHTML();
            document.getElementById('footer-content-input').value = footerHtmlContent;
            
            // Submit the form
            this.submit();
        });

        // Handle featured image source toggle
        const urlOption = document.getElementById('image_url_option');
        const uploadOption = document.getElementById('image_upload_option');
        const urlSection = document.getElementById('url_input_section');
        const fileSection = document.getElementById('file_upload_section');

        urlOption.addEventListener('change', function() {
            if (this.checked) {
                urlSection.classList.remove('d-none');
                fileSection.classList.add('d-none');
            }
        });

        uploadOption.addEventListener('change', function() {
            if (this.checked) {
                fileSection.classList.remove('d-none');
                urlSection.classList.add('d-none');
            }
        });
    });
</script>
{% endblock %}
{% endblock %} 